# PostgreSQL Client Authentication Configuration (pg_hba.conf)
# Garden DX - 造園業向け統合業務管理システム 本番環境用

# =============================================================================
# 認証方式説明
# =============================================================================
# local      - Unixドメインソケット接続
# host       - TCP/IP接続（SSL/非SSL両方）
# hostssl    - SSL接続のみ
# hostnossl  - 非SSL接続のみ
# 
# 認証方法:
# trust      - パスワード不要（開発時のみ）
# md5        - MD5暗号化パスワード（非推奨）
# scram-sha-256 - SCRAM-SHA-256認証（推奨）
# cert       - SSL証明書認証
# =============================================================================

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# =============================================================================
# ローカル接続（管理用）
# =============================================================================

# PostgreSQL管理者（postgres）ローカル接続
local   all             postgres                                scram-sha-256

# データベース管理者ローカル接続
local   all             garden_admin                            scram-sha-256

# =============================================================================
# SSL必須接続（本番環境）
# =============================================================================

# Garden DXアプリケーション接続（SSL必須）
hostssl garden_dx      garden_app      0.0.0.0/0               scram-sha-256
hostssl garden_dx      garden_readonly 0.0.0.0/0               scram-sha-256

# バックアップ用接続（SSL必須）
hostssl garden_dx      garden_backup   0.0.0.0/0               scram-sha-256

# 監視用接続（SSL必須）
hostssl garden_dx      garden_monitor  0.0.0.0/0               scram-sha-256

# =============================================================================
# 管理用接続（SSL必須）
# =============================================================================

# データベース管理者リモート接続
hostssl all            garden_admin    10.0.0.0/8              scram-sha-256
hostssl all            garden_admin    172.16.0.0/12           scram-sha-256
hostssl all            garden_admin    192.168.0.0/16          scram-sha-256

# =============================================================================
# レプリケーション接続（SSL必須）
# =============================================================================

# スタンバイサーバーからのレプリケーション
hostssl replication    replicator      10.0.0.0/8              scram-sha-256
hostssl replication    replicator      172.16.0.0/12           scram-sha-256
hostssl replication    replicator      192.168.0.0/16          scram-sha-256

# =============================================================================
# セキュリティ設定（拒否ルール）
# =============================================================================

# 非SSL接続の拒否（セキュリティ強化）
hostnossl all           all             0.0.0.0/0               reject

# 未認証接続の拒否
host      all           all             0.0.0.0/0               reject

# =============================================================================
# 開発環境用設定（本番では無効化）
# =============================================================================

# 開発環境のみ有効（本番環境では削除またはコメントアウト）
# local   all             all                                     trust
# host    garden_dx       all             127.0.0.1/32            trust
# host    garden_dx       all             ::1/128                 trust

# =============================================================================
# 特別なケース（緊急時のみ）
# =============================================================================

# 緊急時管理者アクセス（通常はコメントアウト）
# hostssl all            postgres        管理者IPアドレス/32      scram-sha-256

# =============================================================================
# 監査・ログ設定
# =============================================================================

# すべての接続がログに記録される（postgresql.confのlog_connectionsがon）
# 失敗した認証もログに記録される（log_min_messages設定による）

# =============================================================================
# IP制限例（企業環境での使用）
# =============================================================================

# 特定オフィスからのみアクセス許可（例）
# hostssl garden_dx      garden_app      203.0.113.0/24          scram-sha-256
# hostssl garden_dx      garden_app      198.51.100.0/24         scram-sha-256

# =============================================================================
# SSL証明書認証（高セキュリティ）
# =============================================================================

# SSL証明書を使った認証（最高セキュリティ）
# hostssl garden_dx      garden_app      0.0.0.0/0               cert clientcert=1

# =============================================================================
# LDAP認証（企業環境）
# =============================================================================

# LDAP/Active Directory統合（企業環境）
# hostssl garden_dx      garden_app      0.0.0.0/0               ldap ldapserver=ldap.company.com ldapport=636 ldapscheme=ldaps ldapbasedn="dc=company,dc=com" ldapbinddn="cn=postgres,ou=service,dc=company,dc=com" ldapbindpasswd="password" ldapsearchattribute="uid"

# =============================================================================
# セキュリティベストプラクティス
# =============================================================================

# 1. SSL/TLS暗号化の強制
# 2. 強力なパスワード認証（scram-sha-256）
# 3. IP範囲制限
# 4. 最小権限の原則
# 5. 定期的な認証ログ監視
# 6. 不要な接続の拒否
# 7. 緊急時アクセス手順の準備

# =============================================================================
# 注意事項
# =============================================================================

# - 設定変更後は 'sudo systemctl reload postgresql' で再読み込み
# - pg_hba.confは上から順に評価される
# - 最初にマッチしたルールが適用される
# - セキュリティテストを定期実行
# - アクセスログの定期監査